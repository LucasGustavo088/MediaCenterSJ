<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Materiais</title>

<link rel="stylesheet" th:href="@{/css/bootstrap.css}" />

<link rel="stylesheet" th:href="@{/css/dropzone.min.css}" />

<style type="text/css">
.dropzone {
	background-image: url("figuras/bgFile.gif");
	padding: 0px;
	margin: 0px;
	background-position: center;
	background-repeat: no-repeat;
	min-height: 200px;
	border: 2px dashed #DCDCDC;
}
</style>

</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<a class="navbar-brand" href="/figuras">Plataforma</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse"
			data-target="#navbarNav" aria-controls="navbarNav"
			aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav">
				<li class="nav-item"><a class="nav-link" href="/categorias">Categorias
				</a></li>				
				<li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
				<li class="nav-item"><a class="nav-link" href="/materiais">Materiais</a></li>


			</ul>
		</div>
	</nav>

	<div class="container-fluid">



		<div class="row" style="margin-top: 20px">

			<div class="col-md-12">

				<h1 class="text-right" style="margin: 10px 0 20px 0">
					<span class="badge" style="background-color: #B8401F; color: #fff">Materiais</span>
				</h1>


				<div id="containerUpload">

					<form action="/upload" class="dropzone" id="up">

						<span class="badge badge-secondary" style="margin: 6px 6px;">Clique
							ou arraste para selecionar o arquivo | imagens, pdf, mp3, mp4 | <
							100 mb</span>

						<div class="fallback">
							<input name="file" type="file" multiple />
						</div>

					</form>


				</div>


				<div class="progress" id="containerProgressBar"
					style="height: 40px; margin: 30px 0; display: none;">
					<div class="progress-bar progress-bar-striped" id="progressBar"
						role="progressbar" aria-valuenow="0" aria-valuemin="0"
						aria-valuemax="100" style="background-color: #A8A454 !important;">
						<h5 style="text-align: center; margin: 12px 0;">
							<span id="progresso"></span>
						</h5>
					</div>
				</div>


			</div>

		</div>

		<div class="row" id="containerPreviewImagem"
			style="margin-top: 30px; display: none;">

			<div class="col-md-5 text-center">

				<img class="img-fluid rounded" id="imagem" />

			</div>

			<div class="col-md-7">

				<h3>Descrição da figura</h3>

				<form method="post" th:object="${figura}"
					th:action="@{/materiais/figura}">
					<div class="form-group" style="margin-top: 20px;">
						<label for="nome">Nome</label> <input type="text"
							class="form-control" id="nomeImagem" th:field="*{nome}">
					</div>
					<div class="form-group" style="margin-top: 20px;">
						<label for="nome">Autor</label> <input type="text"
							class="form-control" id="autor" aria-describedby="autor"
							th:field="*{autor}">
					</div>

					<input type="hidden" class="form-control" id="urlImagem"
						th:field="*{url}" /> <input type="hidden" class="form-control"
						id="nomeOriginalImagem" th:field="*{nomeOriginal}" /> <input
						type="hidden" class="form-control" id="tamanhoImagem"
						th:field="*{tamanho}" />

					<button type="submit" class="btn btn-secondary"
						style="margin-top: 20px;">Salvar</button>

				</form>


			</div>

		</div>



		<div class="row" id="containerPreviewDocumento"
			style="margin-top: 20px; display: none;">

			<div class="col-md-5 text-center">

				<object id="documento" width="450" height="400"></object>

			</div>

			<div class="col-md-7">

				<h3>Descrição do texto</h3>

				<form method="post" th:object="${texto}"
					th:action="@{/materiais/texto}">
					<div class="form-group" style="margin-top: 20px;">
						<label for="nome">Nome</label> <input type="text"
							class="form-control" id="nomeDocumento" th:field="*{nome}">
					</div>
					<div class="form-group" style="margin-top: 20px;">
						<label for="nome">Resumo</label> <input type="text"
							class="form-control" id="resumo" aria-describedby="resumo"
							th:field="*{resumo}">
					</div>

					<input type="hidden" class="form-control" id="urlDocumento"
						th:field="*{url}" /> <input type="hidden" class="form-control"
						id="nomeOriginalDocumento" th:field="*{nomeOriginal}" /> <input
						type="hidden" class="form-control" id="tamanhoDocumento"
						th:field="*{tamanho}" />

					<button type="submit" class="btn btn-secondary"
						style="margin-top: 20px;">Salvar</button>

				</form>

			</div>

		</div>


		<div class="row" id="containerPreviewAudio"
			style="margin-top: 20px; display: none;">

			<div class="col-md-5 text-center">

				<audio autoplay="autoplay" controls="controls" id="audio">
					Erro ao executar!
				</audio>

			</div>

			<div class="col-md-7">

				<h3>Descrição do áudio</h3>

				<form method="post" th:object="${audio}"
					th:action="@{/materiais/audio}">
					<div class="form-group" style="margin-top: 20px;">
						<label for="nome">Nome</label> <input type="text"
							class="form-control" id="nomeDocumento" th:field="*{nome}">
					</div>
					<div class="form-group" style="margin-top: 20px;">
						<label for="nome">Duração</label> <input type="text"
							class="form-control" id="duracao" aria-describedby="duracao"
							th:field="*{duracao}">
					</div>

					<input type="hidden" class="form-control" id="urlDocumento"
						th:field="*{url}" /> <input type="hidden" class="form-control"
						id="nomeOriginalDocumento" th:field="*{nomeOriginal}" /> <input
						type="hidden" class="form-control" id="tamanhoDocumento"
						th:field="*{tamanho}" />

					<button type="submit" class="btn btn-secondary"
						style="margin-top: 20px;">Salvar</button>

				</form>

			</div>

		</div>


		<div class="row" id="containerPreviewVideo"
			style="margin-top: 20px; display: none;">

			<div class="col-md-5 text-center">

				<video width="320" height="240" controls="controls" id="video">
					Erro ao executar!
				</video>

			</div>

			<div class="col-md-7"></div>

		</div>


		<div class="row" id="containerMateriais" style="margin-top: 50px;">



			<div class="col-md-2" th:each="material : ${materiais}">

				<div class="card p-1"
					th:if="${#strings.contains(material, 'Figura')}">

					<img class="card-img-top"
						th:src="@{${'http://localhost:3000/' + material.url }}" alt="Img">

					<div class="card-body">
						<h6 class="card-title" th:text="${material.nome}"></h6>

						<p class="card-text">
							<small
								th:text="${#temporals.format(material.dataRegistro, 'dd/MM/yyyy HH:mm')}"></small>
						</p>

					</div>

				</div>

				<div class="card p-1"
					th:if="${#strings.contains(material, 'Texto')}">

					<span class="text-center"><img class="card-img-top"
						src="/figuras/iconPdf.png" alt="Img"
						style="width: 96px; height: 96px"></span>

					<div class="card-body">
						<h6 class="card-title" th:text="${material.nome}"></h6>

						<p class="card-text">
							<small
								th:text="${#temporals.format(material.dataRegistro, 'dd/MM/yyyy HH:mm')}"></small>
						</p>

					</div>

				</div>

			</div>

		</div>

	</div>



	<!-- Modal -->
	<div class="modal fade" id="containerErro" tabindex="-1" role="dialog"
		aria-labelledby="containerErro" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header"
					style="background-color: #A81533; color: #fff">
					<h5 class="modal-title" id="exampleModalLongTitle">Erro</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close" style="color: #fff">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<span id="msg"></span>
				</div>
			</div>
		</div>
	</div>

	</div>

	<script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>

	<script type="text/javascript" th:src="@{/js/bootstrap.js}"></script>

	<script type="text/javascript" th:src="@{/js/dropzone.min.js}"></script>



	<script type="text/javascript">
	
	let uploadInciado = false;
	
	
	let progressBar = document.querySelector("#progressBar");	
	let progressBarProgresso = document.querySelector("#progresso");
	
	
	let imagem = document.querySelector("#imagem");	
	let documento = document.querySelector("#documento");
	let audio = document.querySelector("#audio");
	let video = document.querySelector("#video");

	
	function erro(file, response){
		
		resetUpload();
			
		let nomeArquivo = file.name;
		
		let tamanhoArquivo = parseFloat((file.size /1024) / 1024).toFixed(3);
		
		let textoErro = '';
		
		if(!file.accepted){					
			
			textoErro = 'Formato ou Tamanho inválido!'
			
		}else{
			
			textoErro = JSON.parse(JSON.stringify(response)).erro;			
		}
		
		$("#containerErro").modal();
	
		document.querySelector("#msg").innerHTML = '<p><b>Arquivo:</b> ' + nomeArquivo + '</p><p><b>Tamanho:</b> ' + tamanhoArquivo + ' Mb</p><p><b>' + textoErro + '</b></p>';
		
		setTimeout(function(){
			
			$("#containerErro").modal("hide");
			
			document.querySelector("#msg").innerHTML = '';
			
		}, 4000);
		
		
	}	
	
	function progressBarCorreBergson(progress, file){
		
		let nomeOriginal = file.name;
		
		let tamanhoArquivo = parseFloat((file.size /1024) / 1024).toFixed(3);
	
		if(!uploadInciado){
			
			uploadInciado = true;			
			
			$("#containerProgressBar").show(); 
			
			$("#containerUpload").hide();
		}
			
		progressBar.setAttribute("aria-valuenow", parseInt(progress));
		
		progressBar.style.width = parseInt(progress) + "%";
				
		progressBarProgresso.innerHTML = nomeOriginal + " - " + tamanhoArquivo + " Mb";
	
	}
	
	
	function resetUpload(){
		
		$("#containerProgressBar").hide();
		
		progressBar.setAttribute("aria-valuenow", 0);
		
		progressBar.style.width = "0%";
		
		progressBarProgresso.innerHTML = "";
		
		uploadInciado = false;	 
		
		$("#containerUpload").show();		
		
	}	
	
	
	function preview(file, response){
		
		let nomeOriginal = file.name;
		
		let url = JSON.parse(JSON.stringify(response)).arquivo;
		
		let tamanhoArquivo = parseFloat((file.size /1024) / 1024).toFixed(3) + " Mb";
		
		let tipo = file.type;
		
		let containerPreview = '#containerPreview';
			
		if(tipo.includes('image/')){
			
			containerPreview += 'Imagem';
			
			let nomeImagem = document.querySelector("#nomeImagem");
			let urlImagem = document.querySelector("#urlImagem");
			let nomeOriginalImagem = document.querySelector("#nomeOriginalImagem");
			let tamanhoImagem = document.querySelector("#tamanhoImagem");
			
			nomeImagem.value = nomeOriginal.split(".")[0];
			
			imagem.src = "http://localhost:3000/" + url;		
			
			urlImagem.value = url;
			
			nomeOriginalImagem.value = nomeOriginal;
			
			tamanhoImagem.value = tamanhoArquivo;
		    
			
		}else if(tipo.includes('application/pdf')){
			
			containerPreview += 'Documento';
			
			let nomeDocumento = document.querySelector("#nomeDocumento");
			let urlDocumento = document.querySelector("#urlDocumento");
			let nomeOriginalDocumento = document.querySelector("#nomeOriginalDocumento");
			let tamanhoDocumento = document.querySelector("#tamanhoDocumento");
			
			nomeDocumento.value = nomeOriginal.split(".")[0];	
			
			urlDocumento.value = url;
			
			nomeOriginalDocumento.value = nomeOriginal;
			
			tamanhoDocumento.value = tamanhoArquivo;
			
			documento.setAttribute("data", "http://localhost:3000/" + url);
			
		
		}else if(tipo.includes('audio/mpeg')){
			
			containerPreview += 'Audio';
			
			audio.innerHTML = '<source src="http://localhost:3000/' + nomeReal+ '" type="audio/mp3" />';
			
		
		}else if(tipo.includes('video/mp4')){
			
			containerPreview += 'Video';
			
			video.innerHTML = '<source src="http://localhost:3000/' + nomeReal+ '" type="video/mp4">';
			
		}
		
		$(containerPreview).toggle('slow');		
		
	}
	
	
		Dropzone.options.up = {
			paramName : "file",
			dictDefaultMessage : "",
			maxFilesize : 100,
			maxFiles: 1,
			parallelUploads : 1,
			acceptedFiles : "application/pdf, image/*, audio/mpeg, video/mp4",
			previewTemplate : '<div style="display:none"></div>',		
			success : function(file, response) {preview(file, response);},			
			error : function(file, response) {erro(file, response);},			
			init : function() {
				
				this.on("uploadprogress", function(file, progress, bytesSent) {
					
					progressBarCorreBergson(progress, file);									
					
				})
			}

		};
	
	</script>

</body>
</html>

